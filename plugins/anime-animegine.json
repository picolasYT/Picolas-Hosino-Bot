import translate from '@vitalets/google-translate-api';
import fetch from 'node-fetch';

const newsletterJid  = '120363335626706839@newsletter';
const newsletterName = 'â¤ÍŸÍà¥‚âƒªáÍœââŸ¡ã€ ğ“Í¢á´‡ğ™–áá´âƒ¨ ğ˜¾ğ’‰ê¯­ğšğ‘›ğ‘›ğ’†ğ‘™: ğ‘¹á´œâƒœÉ“ğ‘¦-ğ‘¯á´ğ’”ğ‘¯ğ™ê¯­ğ‘›ğ’ ã€à¿âŸ¡';

let handler = async (m, { conn, args, usedPrefix, command }) => {
  const contextInfo = {
    mentionedJid: [m.sender],
    isForwarded: true,
    forwardingScore: 999,
    forwardedNewsletterMessageInfo: {
      newsletterJid,
      newsletterName,
      serverMessageId: -1
    },
    externalAdReply: {
      title: botname,
      body: wm,
      thumbnail: icons,
      sourceUrl: redes,
      mediaType: 1,
      renderLargerThumbnail: false
    }
  };

  const prompt = args.join(' ');
  if (!prompt) {
    return conn.reply(
      m.chat,
      `ğŸŒ¸ *Onii-chan~ dime quÃ© imagen deseas ver en estilo anime...* (â—•â€¿â—•âœ¿)\n\nğŸŒ¼ *Ejemplo:* \n\`${usedPrefix + command} Una chica mÃ¡gica con cabello azul y ojos brillantes en un bosque encantado\``,
      m,
      { contextInfo, quoted: m }
    );
  }

  try {
    // Traducir el prompt al inglÃ©s sin mostrarlo
    const { text: translatedPrompt } = await translate(prompt, { to: 'en', autoCorrect: true });

    // Mensaje kawaii mientras carga
    await conn.reply(m.chat, `ğŸ¨ *Generando tu imagen en estilo anime...* âœ¨\n(âŒ’â€¿âŒ’) ã€°ï¸`, m, { contextInfo, quoted: m });

    // API de imagen
    const apiUrl = `https://api.vreden.my.id/api/artificial/animagine?prompt=${encodeURIComponent(translatedPrompt)}`;
    const res = await fetch(apiUrl);
    const json = await res.json();

    const imageUrl = json?.result?.output?.data?.[0]?.image?.url;
    if (!imageUrl) throw new Error('No se pudo generar la imagen.');

    await conn.sendMessage(m.chat, {
      image: { url: imageUrl },
      caption: `â•­â”€â”€â”€â”€â”€â”€â”€âğ“‚ƒâŸ¡ğŸŒ¸âŸ¡ğ“‚ƒââ”€â”€â”€â”€â”€â”€â”€â•®  
ğŸŒ¸ *Â¡AquÃ­ tienes tu imagen generada!* âœ¨  
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€âŠ¹âŠ±âœ¿âŠ°âŠ¹â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

â•­â”€âƒŸ ğŸ–Œï¸ *Prompt:*  
â”‚ â†³ á¯“ ${prompt}
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â•­â”€âƒŸ ğŸ“¦ *Modelo:*  
â”‚ â†³ á¯“ Animagine XL 3.1  
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`,
      mimetype: 'image/png'
    }, { quoted: m, contextInfo });

  } catch (e) {
    console.error(e);
    conn.reply(m.chat, `ğŸ˜¿ *OcurriÃ³ un error al generar tu imagen...*\n\`\`\`${e.message}\`\`\``, m, { contextInfo, quoted: m });
  }
};

handler.help = ['aianime'].map(v => v + ' <texto>');
handler.tags = ['ai', 'anime'];
handler.command = ['animegine', 'imageanime'];
handler.limit = true;
handler.coin = 3;
handler.register = true;

export default handler;